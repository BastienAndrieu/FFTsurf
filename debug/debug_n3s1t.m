clc; clear; close all

addpath('/stck/bandrieu/Bureau/CYPRES/FFTsurf/Matlab/Chebyshev/');
addpath('/stck/bandrieu/Bureau/CYPRES/FFTsurf/FORTRAN/Chebyshev/');
addpath('/stck/bandrieu/Bureau/CYPRES/FFTsurf/FORTRAN/Intersection/Curve-Surface_2/');
addpath('/stck/bandrieu/Bureau/CYPRES/Intersections/');

cls = colorcet('I2', 'N', 3);
cls = CC(cls, 0.0, 0.8, 1.5);


uv = importdata('debug_n3s1t_uv.dat');

for isurf = 1:3
    S(isurf).x = readCoeffs2(sprintf('debug_n3s1t_surf%d.cheb', isurf));
    d = cheb_diff2(S(isurf).x);
    S(isurf).xu = d(:,:,:,1);
    S(isurf).xv = d(:,:,:,2);
end

figure;
hold on

for isurf = 1:3
    si = surf_chebyshev(S(isurf).x, 1);
    set(si, 'facecolor', cls(isurf,:));
    
    x = ICT2unstr(S(isurf).x, uv(:,isurf)');
    plot3(x(1), x(2), x(3), '.', 'color', 0.25*cls(isurf,:));
end

axis image vis3d
view(3);
camproj('persp');
camlight(30,30);


%%
[ stat, uv, res ] = simultaneous_point_inversions( S([1,3]), uv(:,[1,3]));
figure;
plot(res,'.-');
set(gca,'yscale','log');
grid on
legend({...
    '$\left| x_1 - x_2 \right|$', ...
    '$\left| \Delta u_1 \right|$', ...
    '$\left| \Delta u_2 \right|$'}, 'interpreter', 'latex', 'location', 'best');

%%
r = [
    6.1363042601491052E-014   1.2267973152379111E-012   2.8961762810419754E-011   2.0619752076245806E-015   1.1491809215902790E-012
    7.0518453100801372E-014   1.4099832436658559E-012   3.3286369884510963E-011   2.0619752076245802E-015   1.1491809215902790E-012
    7.0518507722793599E-014   1.4099832420158509E-012   3.3286369884441906E-011   2.0619752076245806E-015   1.1491809215902790E-012
    7.0518453100801372E-014   1.4099832436658559E-012   3.3286369884510963E-011   2.0619752076245802E-015   1.1491809215902790E-012
    7.0518507722793599E-014   1.4099832420158509E-012   3.3286369884441906E-011   2.0619752076245806E-015   1.1491809215902790E-012
    7.0518453100801372E-014   1.4099832436658559E-012   3.3286369884510963E-011   2.0619752076245802E-015   1.1491809215902790E-012
    7.0518507722793599E-014   1.4099832420158509E-012   3.3286369884441906E-011   2.0619752076245806E-015   1.1491809215902790E-012
    7.0518453100801372E-014   1.4099832436658559E-012   3.3286369884510963E-011   2.0619752076245802E-015   1.1491809215902790E-012
    7.0518507722793599E-014   1.4099832420158509E-012   3.3286369884441906E-011   2.0619752076245806E-015   1.1491809215902790E-012
    7.0518453100801372E-014   1.4099832436658559E-012   3.3286369884510963E-011   2.0619752076245802E-015   1.1491809215902790E-012
    7.0518507722793599E-014   1.4099832420158509E-012   3.3286369884441906E-011   2.0619752076245806E-015   1.1491809215902790E-012
    7.0518453100801372E-014   1.4099832436658559E-012   3.3286369884510963E-011   2.0619752076245802E-015   1.1491809215902790E-012
    7.0518507722793599E-014   1.4099832420158509E-012   3.3286369884441906E-011   2.0619752076245806E-015   1.1491809215902790E-012
    7.0518453100801372E-014   1.4099832436658559E-012   3.3286369884510963E-011   2.0619752076245802E-015   1.1491809215902790E-012
    ];


figure;
plot(r(:,1:3),'.-');
set(gca,'yscale','log');
grid on
legend({...
    '$\left| x_1 - x_2 \right|$', ...
    '$\left| \Delta u_1 \right|$', ...
    '$\left| \Delta u_2 \right|$'}, 'interpreter', 'latex', 'location', 'best');